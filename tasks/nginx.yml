---
- name: install nginx
  package:
    name: nginx 
    state: latest

- name: ensure nginx user group exists
  group:
    name: "${var.nginx_user}"
    state: present

- name: check if EPEL repo is already configured.
  stat: path="/etc/yum.repos.d/epel.repo"
  register: epel_repofile_result
 
- name: install EPEL repo.
  yum:
    name: "https://dl.fedoraproject.org/pub/epel/epel-release-latest-{{ ansible_distribution_major_version }}.noarch.rpm"
    state: present
  register: result
  when: not epel_repofile_result.stat.exists
 
- name: import EPEL GPG key.
  rpm_key:
    key: "https://dl.fedoraproject.org/pub/epel/RPM-GPG-KEY-EPEL-{{ ansible_distribution_major_version }}"
    state: present
  when: not epel_repofile_result.stat.exists

- name: ensure nginx user exists
  user: 
    name: "${var.nginx_user}" 
    comment: "nginx web user" 
    shell: "/usr/bin/false" 
    groups: "${var.nginx_user}" 
    home: "${var.webroot}"
 
- name: set correct www directory ownership
  file:
    state: directory
    path: "{var.webroot}"
    owner: "${var.nginx_user}"
    group: "${var.nginx_user}"
    recurse: yes

- name: update nginx.conf
  template:
    src: "nginx.conf.j2" 
    dest: "/etc/nginx/nginx.conf" 

- name: "add the site config"
  template:
    src: virtualhost.conf.j2
    dest: "/etc/nginx/conf.d/default.conf"
    owner: root
    group: root